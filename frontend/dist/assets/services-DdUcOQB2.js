class y{static#r=null;#e=[];constructor(){}static getInstance(){return this.#r||(this.#r=new y),this.#r}get groups(){return this.#e}addGroup(e){this.#e.push(e)}pause(e){const t=this.#e.find(r=>r.id===e);t&&(t.isPlaying=!1)}play(e){const t=this.#e.find(r=>r.id===e);t&&(t.isPlaying=!0)}removeGroup(e){this.#e=this.#e.filter(t=>t.id!==e)}update(e){this.#e.forEach(t=>{t.isPlaying&&t.layers.forEach(r=>{if(r.rotation&&r.rotation.direction!=="n/a"){const s=r.rotation.direction==="clockwise"?1:-1;r.rotation.currentAngle=(r.rotation.currentAngle+s*r.rotation.speed*e)%360}if(r.type==="gif"){r.frameElapsed=(r.frameElapsed??0)+e*1e3;const s=1e3/(r.animationProps?.frames.rate||1);for(;r.frameElapsed>=s;)r.frameElapsed-=s,r.currentFrame=((r.currentFrame??0)+1)%r.gifFrames.length}})})}}class i{static#r=null;#e={};#s;#t;constructor(e,t){try{if(this.#s=e,this.#t=t,i.#r)throw new Error("CanvasCacheService is a singleton and cannot be instantiated multiple times.");i.#r=this}catch{throw new Error("Unhandled CanvasCacheService initialization error.")}}static getInstance(e,t){return e.handleSync(()=>(i.#r||(t.info("Creating CanvasCacheService instance."),i.#r=new i(e,t)),t.info("Returning existing CanvasCacheService instance."),i.#r),"Unhandled CanvasCacheService getInstance error.")}get cachedBgImg(){return this.#s.handleSync(()=>(this.#t.debug("Returning cached canvas background img"),this.#e.bgImg),"Unhandled CanvasCacheService cachedBgImg getter error.")}set cachedBgImg(e){this.#s.handleSync(()=>{this.#e.bgImg=e},"Unhandled CanvasCacheService cachedBgImg setter error.")}clearAll(){this.#s.handleSync(()=>{this.#e.bgImg=null},"Unhandled CanvasCacheService clearAll error.")}}class o{static#r=null;#e;#s;#t;#i;#a;constructor(e,t){this.#e={...e},this.#e.layers=e.layers||[],this.#e.selectedLayerIndex=e.selectedLayerIndex??null,this.#s=new Set,this.#t=[],this.#i=[],this.#a=t}static getInstance(e,t){try{return o.#r||(o.#r=new o(e,t)),o.#r}catch(r){throw new Error(`Failed to get CanvasStateService instance: ${r instanceof Error?r.message:String(r)}`)}}addLayer(e){this.#t.push({...this.#e}),this.#e.layers.push(e),this.#n()}addTextElement(e){let t=this.#e.layers.find(r=>r.type==="text");t||(t={id:crypto.randomUUID(),type:"text",assetRef:{name:"TextLayer",class:"text",src:"",size_kb:0,hash_sha256:"",extension:"txt"},opacity:1,visible:!0,zIndex:this.#e.layers.length,textElements:[]},this.#e.layers.push(t)),t.textElements.push(e),this.#n()}canRedo(){return this.#i.length>0}canUndo(){return this.#t.length>0}clearAll(){this.#t.push({...this.#e}),this.#e.layers=[],this.#e.selectedLayerIndex=null,this.#n()}clearAnimation(){this.setAnimation(null)}get(){return{...this.#e}}getAspectRatio(){return this.#e.aspectRatio}getLayers(){return[...this.#e.layers]}getSelectedLayerIndex(){return this.#e.selectedLayerIndex}moveLayer(e,t){const[r]=this.#e.layers.splice(e,1);this.#e.layers.splice(t,0,r),this.#n()}moveTextElement(e,t,r){const s=this.#e.layers.find(n=>n.type==="text");if(s){const n=s.textElements[e];n&&(n.x=t,n.y=r,this.#n())}}redo(){this.#i.length>0&&(this.#t.push({...this.#e}),this.#e=this.#i.pop(),this.#n())}removeLayer(e){this.#t.push({...this.#e}),this.#e.layers.splice(e,1),this.#n()}removeTextElement(e){const t=this.#e.layers.find(r=>r.type==="text");t&&(t.textElements.splice(e,1),this.#n())}reset(){this.set(this.#a.config.defaults.canvasWidth,this.#a.config.defaults.canvasHeight)}set(e,t){this.#t.push({...this.#e}),this.#i=[],this.#e.width=e,this.#e.height=t,this.#n()}setAnimation(e){if(this.#e.layers=this.#e.layers.filter(t=>t.type!=="gif"),e){const t={id:crypto.randomUUID(),type:"gif",assetRef:{name:"GifAnimation",class:"gif",src:"",size_kb:0,hash_sha256:"",extension:"gif"},opacity:1,visible:!0,zIndex:this.#e.layers.length,gifFrames:e.frames,currentFrame:0,frameElapsed:0,position:{x:0,y:0},scale:{x:1,y:1},rotation:{speed:0,direction:"n/a",currentAngle:0}};this.#e.layers.push(t)}this.#n()}setAspectRatio(e){this.#e.aspectRatio=e,this.#n()}setCanvasImage(e){if(this.#e.layers=this.#e.layers.filter(t=>t.type!=="image"),e){const t=new Image;t.src=e;const r={id:crypto.randomUUID(),type:"image",assetRef:{name:"ImageLayer",src:e,class:"image",size_kb:0,hash_sha256:"",extension:"png"},opacity:1,visible:!0,zIndex:0,element:t,position:{x:0,y:0},scale:{x:1,y:1},rotation:{speed:0,direction:"n/a",currentAngle:0}};this.#e.layers.unshift(r)}this.#n()}setSelectedLayerIndex(e){this.#e.selectedLayerIndex=e,this.#n()}subscribe(e){return this.#s.add(e),e(this.get()),()=>this.#s.delete(e)}undo(){this.#t.length>0&&(this.#i.push({...this.#e}),this.#e=this.#t.pop(),this.#n())}updateLayer(e,t){this.#e.layers[e]=t,this.#n()}updateTextElement(e,t){const r=this.#e.layers.find(s=>s.type==="text");r&&(r.textElements[e]=t,this.#n())}#n(){const e=this.get();for(const t of this.#s)t(e)}}class c{static#r=null;#e;#s;constructor(e){this.#e={...e},this.#s=new Set}static getInstance(e){try{return c.#r||(c.#r=new c(e)),c.#r}catch(t){throw new Error(`Failed to get ClientStateService instance: ${t instanceof Error?t.message:String(t)}`)}}get(){return{...this.#e}}set(e,t){this.#e.viewportWidth=e,this.#e.viewportHeight=t,this.#t()}subscribe(e){return this.#s.add(e),e(this.get()),()=>this.#s.delete(e)}#t(){const e=this.get();for(const t of this.#s)t(e)}}class p extends Error{constructor(e,t){super(e),this.userMessage=t,this.name="UserFacingError"}}const w={UserFacingError:p};class h{static#r=null;#e=w;#s;constructor(e){try{this.#s=e}catch(t){throw new Error(`${t instanceof Error?t.message:t}`)}}static getInstance(e){try{return h.#r||(console.debug("No ErrorHandler instance exists yet. Creating new instance."),h.#r=new h(e)),console.debug("Returning ErrorHandler instance."),h.#r}catch(t){throw new Error(`${t instanceof Error?t.message:t}`)}}handleAndReturn(e,t,r={}){try{const s=e();return s instanceof Promise?s.catch(n=>(this.#i(n,t,r),r.fallback??Promise.reject(n))):s}catch(s){return this.#i(s,t,r),r.fallback}}async handleAsync(e,t,r={}){try{return await e()}catch(s){throw this.#i(s,t,r),s}}handleSync(e,t,r={}){try{return e()}catch(s){throw this.#i(s,t,r),s}}#t(e,t,r){try{return e instanceof Error?`${t}: ${e.message}. Context: ${JSON.stringify(r)}`:`${t}: ${e}. Context: ${JSON.stringify(r)}`}catch(s){throw new Error(`[Error formatting error message: ${s instanceof Error?s.message:s}`)}}#i(e,t,r={}){try{const s=typeof r.context=="object"&&r.context!==null?r.context:{},n=this.#t(e,t,s);this.#s.error(n);const f=r.userMessage??(e instanceof this.#e.UserFacingError?e.userMessage:void 0);f&&alert(f)}catch(s){throw new Error(`Error handling error: ${s instanceof Error?s.message:s}`)}}}class a{static DB_NAME="graphix-app";static STORE="app-data";#r;constructor(e){this.#r=e}static create(){return new Promise((e,t)=>{const r=indexedDB.open(a.DB_NAME,1);r.onupgradeneeded=()=>{const s=r.result;s.objectStoreNames.contains(a.STORE)||s.createObjectStore(a.STORE)},r.onsuccess=()=>{e(new a(r.result))},r.onerror=()=>{t(r.error)}})}clear(){return new Promise((e,t)=>{const r=this.#e("readwrite").clear();r.onsuccess=()=>e(),r.onerror=()=>t(r.error)})}get(e){return new Promise((t,r)=>{const s=this.#e("readonly").get(e);s.onsuccess=()=>t(s.result?JSON.parse(s.result):null),s.onerror=()=>r(s.error)})}remove(e){return new Promise((t,r)=>{const s=this.#e("readwrite").delete(e);s.onsuccess=()=>t(),s.onerror=()=>r(s.error)})}set(e,t){return new Promise((r,s)=>{const n=this.#e("readwrite").put(JSON.stringify(t),e);n.onsuccess=()=>r(),n.onerror=()=>s(n.error)})}#e(e){return this.#r.transaction(a.STORE,e).objectStore(a.STORE)}}class v{get(e){return Promise.resolve(localStorage.getItem(e)?JSON.parse(localStorage.getItem(e)):null)}set(e,t){return localStorage.setItem(e,JSON.stringify(t)),Promise.resolve()}remove(e){return localStorage.removeItem(e),Promise.resolve()}clear(){return localStorage.clear(),Promise.resolve()}}class l{static#r=null;constructor(e){try{e.app.noop()}catch(t){throw new Error(`constructor]: ${t instanceof Error?t.message:t}`)}}static getInstance(e){try{return l.#r||(l.#r=new l(e),console.log("No existing Logger instance found. Creating new instance.")),console.log("Returning Logger instance."),l.#r}catch(t){throw new Error(`${t instanceof Error?t.message:t}`)}}debug(e,t){this.#t(e,"debug",t)}error(e,t){this.#t(e,"error",t)}info(e,t){this.#t(e,"info",t)}warn(e,t){this.#t(e,"warn",t)}#e(){return new Date().toLocaleString("en-US",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1})}#s(e){switch(e){case"debug":return"color: green";case"info":return"color: blue";case"warn":return"color: orange";case"error":return"color: red";default:return"color: black"}}#t(e,t,r){const s=r,n=this.#e();try{console.log(`%c[${t.toUpperCase()}]%c ${n} [${s}] %c${e}`,this.#s(t),"color: gray","color: inherit")}catch(f){console.error(`[${r}.#logMessage]: Encountered an unexpected error: ${f}.`)}s==="Unknown caller"&&console.trace(`[${r}]: Full Stack Trace:`)}}class g{static#r=null;#e=new Set;#s;#t;constructor(e,t){try{t.info("Initializing ResizeManager..."),this.#s=e,this.#t=t,this.initialize(),t.info("ResizeManager initialized successfully.")}catch(r){throw new Error(`Failed to initialize ResizeManager: ${r instanceof Error?r.message:String(r)}`)}}static getInstance(e,t){try{return g.#r||(g.#r=new g(e,t)),g.#r}catch(r){throw new Error(`Failed to get ResizeManager instance: ${r instanceof Error?r.message:String(r)}`)}}initialize(){this.#s.handleSync(()=>{this.#t.info("Registering Window Resize event listeners..."),document.addEventListener("DOMContentLoaded",this.runAll.bind(this))},"ResizeManager initialization failed.")}register(e){this.#e.add(e)}runAll(){this.#e.forEach(e=>{try{e()}catch(t){console.error("[ResizeManager] Plugin error:",t)}})}unregister(e){this.#e.delete(e)}}class d{static#r=null;#e=null;#s=[];#t;#i;#a;#n;#o;constructor(e,t,r){try{r.info("Initializing StateManager...","[StateManager constructor]"),this.#a=e,this.#n=t,this.#o=r,this.#e=e.version;let s={version:this.#a.version,canvas:{width:this.#a.config.defaults.canvasWidth,height:this.#a.config.defaults.canvasHeight,layers:[],selectedLayerIndex:null},client:{viewportWidth:window.innerWidth,viewportHeight:window.innerHeight}};const n=window.localStorage.getItem("appState");if(n)try{Object.assign(s,JSON.parse(n)),r.info("StateManager hydrated from localStorage.","[StateManager constructor]")}catch{r.warn("Failed to parse localStorage state. Using default values.","[StateManager constructor]")}this.#t=o.getInstance(s.canvas,this.#a),this.#i=c.getInstance(s.client),this.#t.subscribe(()=>this.#c()),this.#i.subscribe(()=>this.#c()),r.info("StateManager initialized successfully.","[StateManager constructor]")}catch(s){throw new Error(`Failed to initialize StateManager: ${s instanceof Error?s.message:String(s)}`)}}static getInstance(e,t,r){try{return r.info("Calling StateManager.getInstance()..."),d.#r?(r.info("Returning existing StateManager instance."),d.#r):(r.info("No existing StateManager instance found. Creating new instance."),d.#r=new d(e,t,r))}catch(s){throw new Error(`Failed to get StateManager instance: ${s instanceof Error?s.message:String(s)}`)}}addLifecycleHook(e){this.#n.handleSync(()=>{if(this.#o.info("Adding lifecycle hook.","StateManager.addLifecycleHook()"),typeof e!="function")throw new Error("Lifecycle hook must be a function.");this.#s.push(e),this.#o.info("Lifecycle hook added successfully.","StateManager.addLifecycleHook()")},"Failed to add lifecycle hook.")}getState(){return this.#n.handleSync(()=>(this.#o.info("Returning current state.","StateManager.getState()"),{version:this.#e,canvas:this.getCanvas(),client:this.getClient()}),"Failed to return state.")}addLayer(e){this.#t.addLayer(e);for(const t of this.#s)t("addLayer",this.getCanvas())}addTextElement(e){this.#t.addTextElement(e)}canRedoCanvas(){return this.#t.canRedo()}canUndoCanvas(){return this.#t.canUndo()}clearCanvasAll(){this.#t.clearAll(),window.localStorage.setItem("appState",JSON.stringify(this.getState()))}clearCanvasAnimation(){this.#t.clearAnimation()}getCanvas(){return this.#t.get()}getCanvasAspectRatio(){return this.#t.getAspectRatio()}moveLayer(e,t){this.#t.moveLayer(e,t)}moveTextElement(e,t,r){this.#t.moveTextElement(e,t,r)}redoCanvas(){this.#t.redo()}removeLayer(e){this.#t.removeLayer(e)}removeTextElement(e){this.#t.removeTextElement(e)}resetCanvas(){this.#t.reset()}setCanvas(e,t){this.#t.set(e,t)}setCanvasAnimation(e){this.#t.setAnimation(e)}setCanvasAspectRatio(e){this.#t.setAspectRatio(e)}setCanvasImage(e){this.#t.setCanvasImage(e)}setSelectedLayerIndex(e){this.#t.setSelectedLayerIndex(e)}subscribeToCanvas(e){return this.#t.subscribe(e)}undoCanvas(){this.#t.undo()}updateLayer(e,t){this.#t.updateLayer(e,t)}updateTextElement(e,t){this.#t.updateTextElement(e,t)}getClient(){return this.#i.get()}setClient(e,t){this.#i.set(e,t)}subscribeToClient(e){return this.#i.subscribe(e)}#c(){return this.#n.handleSync(()=>{window.localStorage.setItem("appState",JSON.stringify(this.getState()))},"Failed to persist state to localStorage.")}}class u{static#r=null;#e;constructor(e){this.#e=e}static async getInstance(){if(!u.#r){let e;try{e=await a.create()}catch{e=new v}u.#r=new u(e)}return u.#r}get(e){return this.#e.get(e)}set(e,t){return this.#e.set(e,t)}remove(e){return this.#e.remove(e)}clear(){return this.#e.clear()}}async function E(m,e){console.log("Starting service factory...");const t={};if(console.log("Initializing Logger, ErrorHandler, and StateManager services"),t.log=l.getInstance(e),t.errors=h.getInstance(t.log),t.storageManager=await u.getInstance(),t.stateManager=d.getInstance(m,t.errors,t.log),t.cache=i.getInstance(t.errors,t.log),t.resizeManager=g.getInstance(t.errors,t.log),t.animationGroupManager=y.getInstance(),!t.log||!t.errors)throw new Error("Logger and/or ErrorHandler failed to initialize.");return t}export{E as serviceFactory};
