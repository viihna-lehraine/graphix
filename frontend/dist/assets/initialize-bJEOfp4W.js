const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/helpers-Cy31uG_E.js","assets/index-CMuSpS8o.js","assets/index-Bcp8qmdP.css","assets/utilities-WAyycJSI.js","assets/start-gU6WD5i7.js"])))=>i.map(i=>d[i]);
import{_ as h}from"./index-CMuSpS8o.js";class c{static#o=null;#a;#r;#s=[];#e=null;#c;#t;#i;#l;#h;#n;constructor(e,t){const{data:i,helpers:a,services:{errors:n,log:o,stateManager:l},utils:s}=t;this.#e=e,this.#c=t,this.#a=i,this.#i=a,this.#n=s,this.#r=i.flags.devMode,this.#t=n,this.#l=o,this.#h=l,this.#h.subscribeToCanvas(()=>{this.render()})}static getInstance(e,t){const{errors:i,log:a}=t.services;return i.handleSync(()=>(a.info("RENDERING_ENGINE: calling getInstance()..."),c.#o||(a.info("RENDERING_ENGINE: No existing instance found. Creating new instance."),c.#o=new c(e,t)),c.#o),"RENDERING_ENGINE: Failed to get instance.")}render(e=this.#h.getCanvas()){return this.#t.handleSync(()=>{this.clearCanvas(this.#e),this.#r&&this.drawDevOverlay(),this.drawBoundary(this.#e),e.layers.length>0&&this.#n.canvas.drawVisualLayersToContext(this.#e,e.layers,this.#i),this.#d(this.#e,e.layers,e.selectedLayerIndex);for(const t of this.#s)t(this.#e,this.#c)},"RENDERING_ENGINE: Failed to render canvas.")}addRedrawPlugin(e){return this.#t.handleSync(()=>{this.#s.push(e)},"RENDERING_ENGINE: Failed to add redraw plugin.")}attachImageOnLoadHandler(e){e.element&&!e.element.complete&&this.render()}autoResize({canvas:e,container:t,preserveAspectRatio:i=!0}){return this.#t.handleSync(()=>{const a=()=>{const n=t.getBoundingClientRect();if(i){const o=e.width/e.height||1.3333333333333333;let l=n.width,s=n.width/o;s>n.height&&(s=n.height,l=n.height*o),e.style.width=`${l}px`,e.style.height=`${s}px`}else e.style.width=`${n.width}px`,e.style.height=`${n.height}px`};return a(),window.addEventListener("resize",a),()=>window.removeEventListener("resize",a)},"Unhandled canvas auto-resize error.")}clearCanvas(e){return this.#t.handleSync(()=>{e.clearRect(0,0,e.canvas.width,e.canvas.height)},"RENDERING_ENGINE: Unhandled canvas clear error.")}drawBoundary(e){return this.#t.handleSync(()=>{e.save(),e.lineWidth=8,e.strokeStyle="#ff80c5ff",e.setLineDash([12,10]),e.strokeRect(0,0,e.canvas.width,e.canvas.height),e.restore()},"Unhandled canvas boundary drawing error.")}drawDevOverlay(){return this.#t.handleSync(()=>{this.#e.save(),this.#e.strokeStyle="rgba(255,0,0,0.25)",this.#e.lineWidth=1,this.#e.setLineDash([4,4]),this.#e.beginPath(),this.#e.moveTo(0,this.#e.canvas.height/2),this.#e.lineTo(this.#e.canvas.width,this.#e.canvas.height/2),this.#e.moveTo(this.#e.canvas.width/2,0),this.#e.lineTo(this.#e.canvas.width/2,this.#e.canvas.height),this.#e.stroke(),this.#e.restore()},"RENDERING_ENGINE: Failed to draw dev overlay.")}redraw(e,t){return this.#t.handleSync(()=>{this.clearCanvas(e),this.drawBoundary(e),this.#n.canvas.drawVisualLayersToContext(e,t.layers,this.#i),this.#d(e,t.layers,t.selectedLayerIndex)},"Unhandled canvas redraw error.")}removeRedrawPlugin(e){return this.#t.handleSync(()=>{this.#s=this.#s.filter(t=>t!==e)},"RENDERING_ENGINE: Failed to remove redraw plugin.")}renderTo(e,t){return this.#t.handleSync(()=>{const i=this.#r,a=this.#e;this.#e=e,this.render(t),this.#e=a,this.#r=i},"RENDERING_ENGINE: Failed to render to provided context.")}resizeCanvasToParent(){return this.#t.handleSync(()=>{const e=document.getElementById(this.#a.dom.ids.canvas);if(!e)throw new Error("Canvas element not found!");const t=e.parentElement;if(!t)throw new Error("Canvas has no parent element!");const i=t.getBoundingClientRect(),a=window.devicePixelRatio||1;e.width=Math.round(i.width*a),e.height=Math.round(i.height*a),e.style.width=`${i.width}px`,e.style.height=`${i.height}px`},"Unhandled canvas resize error.")}#d(e,t,i){return this.#t.handleSync(()=>{const a=t.find(n=>n.type==="text");if(a){for(const n of a.textElements){e.save();const o=n.fontSize??32,l=n.fontWeight??"bold",s=n.fontFamily??"sans-serif";e.font=`${l} ${o}px ${s}`,e.fillStyle=n.color,e.textAlign=n.align,e.textBaseline=n.baseline,e.fillText(n.text,n.x,n.y),e.restore()}i!==null&&t[i]?.type==="text"&&(e.save(),e.strokeStyle="#00F6",e.lineWidth=2,e.setLineDash([4,2]),e.strokeRect(0,0,e.canvas.width,e.canvas.height),e.restore())}},"Unhandled canvas text and selection drawing error.")}_(){this.#a=this.#a,this.#t=this.#t,this.#i=this.#i,this.#l=this.#l,this.#n=this.#n}}async function y(){console.log("Initializing Data object...");try{const{data:r}=await h(async()=>{const{data:e}=await import("./index-CWL3xo6d.js");return{data:e}},[]);return r}catch(r){throw console.error("Failed to initialize Data:",r),new Error("Data initialization failed")}}async function g(){console.log("Initializing Helpers object...");try{const{helpersFactory:r}=await h(async()=>{const{helpersFactory:t}=await import("./helpers-Cy31uG_E.js");return{helpersFactory:t}},__vite__mapDeps([0,1,2]));return await r()}catch(r){throw console.error("Failed to initialize Helpers:",r),new Error("Helpers initialization failed")}}async function E(r,e){console.log("Initializing Services object...");try{const{serviceFactory:t}=await h(async()=>{const{serviceFactory:a}=await import("./services-DdUcOQB2.js");return{serviceFactory:a}},[]);return await t(r,e)}catch(t){throw console.error("Failed to initialize Services:",t),new Error("Services initialization failed")}}async function f(r){return console.log("Initializing Utilities object..."),await r.errors.handleAsync(async()=>{const{utilitiesFactory:e}=await h(async()=>{const{utilitiesFactory:i}=await import("./utilities-WAyycJSI.js");return{utilitiesFactory:i}},__vite__mapDeps([3,1,2]));return await e(r)},"Utilities initialization failed.")}async function I(){console.log("Starting dependency initialization...");let r={};const e=await y();r.data=e;const t=await g();r.helpers=t;const i=await E(e,t);r.services=i;const a=await f(i);return r.utils=a,i.log.info("All dependencies initialized successfully."),r}async function p(r,e){const{services:{errors:t,log:i}}=e;return t.handleAsync(async()=>(i.info("Initializing the Rendering Engine..."),c.getInstance(r,e)),"Rendering Engine initialization failed.")}async function z(r){const{data:{dom:{ids:e}},services:t}=r,{errors:i}=t;return i.handleAsync(async()=>{const a=document.getElementById(e.canvas);if(!a)throw new Error("Canvas element not found in DOM!");const n=a.getContext("2d");if(!n)throw new Error("2D context not available for canvas!");const o=document.getElementById(e.canvasContainerDiv);if(!o)throw new Error("Canvas container not found in DOM!");const l={ctx:n},s=await p(n,r),{io:u}=await h(async()=>{const{io:d}=await import("./io-3QFxYgux.js");return{io:d}},[]),{overlayFns:v}=await h(async()=>{const{overlayFns:d}=await import("./overlays-DgNZSUn9.js");return{overlayFns:d}},[]),{initializeCanvasUI:w}=await h(async()=>{const{initializeCanvasUI:d}=await import("./start-gU6WD5i7.js");return{initializeCanvasUI:d}},__vite__mapDeps([4,1,2]));return await w(u,v,r,s),s.autoResize({canvas:a,container:o,preserveAspectRatio:!0}),window.addEventListener("resize",()=>{i.handleSync(()=>{s.resizeCanvasToParent(),s.clearCanvas(l.ctx),s.drawBoundary(l.ctx)},"Canvas resize/redraw failed")}),s},"UI initialization failed.")}export{I as initializeCore,y as initializeData,p as initializeRenderingEngine,z as initializeUI};
